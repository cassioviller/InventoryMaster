# Guia Detalhado para Corre√ß√£o de Conex√£o com Banco de Dados no Replit e EasyPanel

## Introdu√ß√£o

Este documento visa fornecer um guia abrangente e detalhado para solucionar o erro fatal de conex√£o com o banco de dados PostgreSQL, especificamente a mensagem `database "axiom" does not exist`, que tem sido observada em seu ambiente de desenvolvimento no Replit e, potencialmente, em seu ambiente de produ√ß√£o no EasyPanel. A an√°lise aprofundada das informa√ß√µes fornecidas ‚Äì incluindo trechos de c√≥digo, logs de erro, capturas de tela das configura√ß√µes do Replit e do EasyPanel, e a estrutura do banco de dados ‚Äì nos permitir√° identificar a raiz do problema e propor solu√ß√µes precisas e duradouras. O objetivo √© garantir que sua aplica√ß√£o Node.js se conecte corretamente ao banco de dados `almoxarifado`, eliminando qualquer refer√™ncia incorreta a `axiom`.

Este guia abordar√°:

1.  **An√°lise Detalhada do Problema:** Compreens√£o da origem do erro `database "axiom" does not exist`.
2.  **Corre√ß√µes no Ambiente Replit:** Ajustes necess√°rios nas vari√°veis de ambiente (Secrets) para o desenvolvimento.
3.  **Corre√ß√µes no Ambiente EasyPanel:** Configura√ß√µes de vari√°veis de ambiente para o deploy em produ√ß√£o.
4.  **An√°lise do C√≥digo-Fonte:** Verifica√ß√£o da l√≥gica de conex√£o em `db-production-only.ts` e o papel dos scripts de build.
5.  **An√°lise do Dockerfile e Scripts de Entrada:** Como o ambiente de cont√™iner √© constru√≠do e como as vari√°veis s√£o passadas.
6.  **Passos de Verifica√ß√£o e Teste:** Como confirmar que as corre√ß√µes foram aplicadas com sucesso.

Nosso objetivo √© fornecer uma solu√ß√£o robusta que n√£o apenas resolva o problema imediato, mas tamb√©m reforce as boas pr√°ticas de configura√ß√£o de ambiente e deploy.

## 1. An√°lise Detalhada do Problema: O Erro `database "axiom" does not exist`

O erro `FATAL: database "axiom" does not exist` √© uma indica√ß√£o clara de que o cliente PostgreSQL (sua aplica√ß√£o Node.js) est√° tentando se conectar a um banco de dados chamado `axiom`, mas este banco n√£o existe no servidor PostgreSQL ao qual a aplica√ß√£o est√° se conectando. Com base nas informa√ß√µes e imagens fornecidas, o nome correto do banco de dados √© `almoxarifado`.

Observamos que a URL de conex√£o interna exibida na configura√ß√£o do Replit para o servi√ßo `viajey_cassio` (que √© o seu banco de dados PostgreSQL) j√° mostra o nome correto do banco: `postgres://axiom:estruturas@viajey_cassio:5432/almoxarifado?sslmode=disable` [1]. Isso sugere que a configura√ß√£o do banco de dados em si no Replit est√° correta.

No entanto, os logs de erro (`2025-06-24 14:56:13.471 UTC [588] FATAL: database 


"axiom" does not exist`) indicam que, em algum ponto do processo de inicializa√ß√£o da aplica√ß√£o, a string de conex√£o utilizada para estabelecer a conex√£o com o banco de dados ainda continha a refer√™ncia incorreta a `axiom` como nome do banco. Isso pode ocorrer por algumas raz√µes:

*   **Vari√°veis de Ambiente Desatualizadas:** O ambiente de execu√ß√£o (seja no Replit ou no EasyPanel) pode estar carregando uma vers√£o antiga da vari√°vel de ambiente `DATABASE_URL` que ainda cont√©m o nome `axiom`.
*   **Cache de Configura√ß√£o:** Em alguns ambientes, as configura√ß√µes podem ser cacheadas e n√£o s√£o atualizadas imediatamente ap√≥s uma altera√ß√£o, exigindo um rein√≠cio completo do servi√ßo ou da m√°quina.
*   **Hardcoding em Outro Local:** Embora o trecho de c√≥digo `db-production-only.ts` fornecido j√° mostre `almoxarifado`, pode haver outra parte do c√≥digo ou um script de inicializa√ß√£o que esteja construindo a URL de conex√£o de forma incorreta ou usando uma vari√°vel diferente.

A imagem dos logs do EasyPanel (`image.png` - logs do `viajey / almoxa APP`) tamb√©m mostra a linha `Database name: almoxarifado`, o que √© um bom sinal, indicando que a aplica√ß√£o *est√° lendo* o nome correto do banco em algum momento. No entanto, o erro `FATAL: database 


"axiom" does not exist` ainda aparece nos logs do servi√ßo `viajey / cassio POSTGRES`, o que sugere que a conex√£o inicial ou alguma parte do sistema ainda est√° usando a string antiga. √â crucial garantir que todas as inst√¢ncias da `DATABASE_URL` sejam atualizadas e que o ambiente seja reiniciado para que as mudan√ßas sejam efetivadas.

## 2. Corre√ß√µes no Ambiente Replit: Garantindo a Conex√£o Correta em Desenvolvimento

No ambiente Replit, a forma mais comum e recomendada de gerenciar vari√°veis de ambiente sens√≠veis, como a `DATABASE_URL`, √© atrav√©s da funcionalidade de **Secrets**. Isso garante que suas credenciais n√£o sejam expostas diretamente no c√≥digo-fonte e que o Replit as injete no ambiente de execu√ß√£o do seu projeto. Com base nas informa√ß√µes fornecidas, a `DATABASE_URL` para o ambiente de desenvolvimento deve apontar para o banco de dados `almoxarifado`.

Para corrigir e verificar a configura√ß√£o no Replit, siga os passos abaixo:

1.  **Acessar a Se√ß√£o de Secrets (Vari√°veis de Ambiente):**
    *   Abra seu projeto no Replit.
    *   No painel lateral esquerdo do editor, localize e clique no √≠cone de cadeado (Secrets). Este √© o local onde todas as vari√°veis de ambiente do seu projeto s√£o gerenciadas.

2.  **Verificar e Atualizar a Vari√°vel `DATABASE_URL`:**
    *   Dentro da se√ß√£o de Secrets, procure por uma vari√°vel chamada `DATABASE_URL`. √â fundamental que esta vari√°vel exista e contenha o valor correto.
    *   **Valor Esperado:** O valor da `DATABASE_URL` deve ser:
        ```
        postgres://axiom:estruturas@viajey_cassio:5432/almoxarifado?sslmode=disable
        ```
        *   **Observa√ß√£o:** A imagem de suas credenciais do Replit [1] j√° mostra esta URL de conex√£o interna. O problema √© que, apesar de estar correta na interface, o ambiente de execu√ß√£o pode estar lendo uma vers√£o antiga ou uma vari√°vel com nome diferente.

    *   **A√ß√£o Necess√°ria:**
        *   **Se a vari√°vel `DATABASE_URL` existir, mas o valor estiver incorreto** (por exemplo, ainda contendo `axiom` no nome do banco de dados ou qualquer outra discrep√¢ncia), **edite-a** para o valor exato fornecido acima.
        *   **Se a vari√°vel `DATABASE_URL` n√£o existir**, clique em 


"Add new secret", insira `DATABASE_URL` como nome e o valor `postgres://axiom:estruturas@viajey_cassio:5432/almoxarifado?sslmode=disable`.
        *   **Verifique tamb√©m se n√£o h√° outras vari√°veis de ambiente com nomes semelhantes** (ex: `DB_CONNECTION_STRING`, `POSTGRES_URL`) que possam estar sendo usadas inadvertidamente e que ainda contenham a refer√™ncia a `axiom`. Se encontrar, atualize-as ou remova-as, garantindo que apenas a `DATABASE_URL` correta seja utilizada.

3.  **Salvar e Aplicar as Altera√ß√µes:**
    *   Ap√≥s realizar as edi√ß√µes ou adi√ß√µes, certifique-se de que as altera√ß√µes foram salvas na interface do Replit. O Replit geralmente salva automaticamente ou possui um bot√£o de 


`Save` ou `Update`.
    *   Para que as novas vari√°veis de ambiente sejam efetivamente carregadas pelo seu projeto, √© **crucial reiniciar o Replit**. Voc√™ pode fazer isso parando a execu√ß√£o do seu projeto (se estiver rodando) e iniciando-o novamente. Isso for√ßa o Replit a recarregar o ambiente com as vari√°veis atualizadas.

## 3. Corre√ß√µes no Ambiente EasyPanel: Configura√ß√µes para o Deploy em Produ√ß√£o

O EasyPanel, como ambiente de produ√ß√£o, tamb√©m depende fortemente de vari√°veis de ambiente para configurar a conex√£o com o banco de dados. √â fundamental que a `DATABASE_URL` configurada no EasyPanel reflita o nome correto do banco (`almoxarifado`).

Para ajustar as configura√ß√µes no EasyPanel, siga estes passos:

1.  **Acessar o Painel do Servi√ßo no EasyPanel:**
    *   Fa√ßa login no seu painel do EasyPanel.
    *   Navegue at√© o servi√ßo correspondente √† sua aplica√ß√£o Node.js (provavelmente `viajey / almoxa APP`, conforme as imagens fornecidas).

2.  **Configurar Vari√°veis de Ambiente (Environment):**
    *   Dentro das configura√ß√µes do seu servi√ßo, localize a aba ou se√ß√£o de **Environment Variables** (ou apenas **Environment**).
    *   Nesta se√ß√£o, voc√™ precisar√° adicionar ou editar as vari√°veis de ambiente que sua aplica√ß√£o utiliza. As mais importantes para a conex√£o com o banco de dados s√£o:
        *   `NODE_ENV`: Defina como `production`.
        *   `PORT`: Defina como `5013` (conforme seu c√≥digo `index.ts` e logs).
        *   `DATABASE_URL`: Esta √© a vari√°vel mais cr√≠tica. O valor deve ser exatamente:
            ```
            postgres://axiom:estruturas@viajey_cassio:5432/almoxarifado?sslmode=disable
            ```
            *   **Importante:** Verifique se n√£o h√° espa√ßos em branco extras ou caracteres ocultos. Certifique-se de que o nome do banco de dados (`almoxarifado`) est√° correto e n√£o `axiom`.

    *   **Como Inserir no EasyPanel:** O EasyPanel geralmente oferece campos separados para `Key` (chave) e `Value` (valor) para cada vari√°vel. Insira cada par (`NODE_ENV`, `production`), (`PORT`, `5013`), (`DATABASE_URL`, `postgres://...almoxarifado?sslmode=disable`) separadamente.

3.  **Salvar e Re-implantar a Aplica√ß√£o:**
    *   Ap√≥s adicionar/editar as vari√°veis de ambiente, clique em **Save** ou **Apply Changes** para que as configura√ß√µes sejam salvas.
    *   Em seguida, voc√™ precisar√° **re-implantar (re-deploy)** sua aplica√ß√£o. No EasyPanel, geralmente h√° um bot√£o de `Deploy` ou `Rebuild` na aba principal do servi√ßo. Clicar nele for√ßar√° o EasyPanel a reconstruir e reiniciar seu cont√™iner com as novas vari√°veis de ambiente.

## 4. An√°lise do C√≥digo-Fonte: `db-production-only.ts` e a L√≥gica de Conex√£o

O trecho de c√≥digo de `db-production-only.ts` que voc√™ forneceu √© fundamental para entender como a aplica√ß√£o estabelece a conex√£o com o banco de dados. Vamos analisar as linhas relevantes:

```typescript
// CONEX√ÉO INTELIGENTE - DEV USA NEON, PROD USA VIAJEY_CASSIO
const isDevelopment = process.env.NODE_ENV === 'development';
const connectionString = isDevelopment 
  ? process.env.DATABASE_URL
  : "postgres://axiom:estruturas@viajey_cassio:5432/almoxarifado?sslmode=disable";

console.log('üîó Conectando diretamente ao PostgreSQL...');
console.log('Ambiente:', process.env.NODE_ENV || 'development');
console.log('String de conex√£o:', connectionString ? 'Configurada' : 'N√£o definida');

// Parse URL para debug
if (connectionString) {
  try {
    const dbUrl = new URL(connectionString);
    console.log('Database host:', dbUrl.hostname);
    console.log('Database name:', dbUrl.pathname.slice(1));
    console.log('Database user:', dbUrl.username);
    console.log('Database port:', dbUrl.port || '5432');
  } catch (error) {
    console.log('Erro ao fazer parse da URL:', error);
  }
} else {
  console.log('‚ùå CONNECTION STRING N√ÉO DEFINIDA');
}

if (!connectionString) {
  throw new Error('‚ùå DATABASE_URL n√£o est√° definida!');
}

export const pool = new Pool({ 
  connectionString,
  ssl: false
});
```

**Pontos Chave da An√°lise:**

*   **L√≥gica Condicional:** A vari√°vel `connectionString` √© definida com base no `NODE_ENV`. Se `NODE_ENV` for `development`, a aplica√ß√£o tenta usar `process.env.DATABASE_URL`. Caso contr√°rio (ou seja, em produ√ß√£o), ela usa uma string de conex√£o *hardcoded*.
*   **String Hardcoded Correta:** A string hardcoded `"postgres://axiom:estruturas@viajey_cassio:5432/almoxarifado?sslmode=disable"` **j√° est√° correta** e aponta para `almoxarifado`. Isso √© um bom sinal, pois significa que o c√≥digo-fonte em si n√£o √© a causa do erro `axiom` em produ√ß√£o, *assumindo que esta vers√£o do c√≥digo est√° de fato em execu√ß√£o no EasyPanel*.
*   **Logs de Debug:** As linhas `console.log` para `Database host`, `Database name`, `Database user` e `Database port` s√£o extremamente √∫teis. Os logs que voc√™ forneceu do EasyPanel (`image.png` - logs do `viajey / almoxa APP`) mostram:
    ```
    Database host: viajey_cassio
    Database name: almoxarifado
    Database user: axiom
    Database port: 5432
    ```
    Isso confirma que, no momento em que esses logs foram gerados, a aplica√ß√£o estava lendo a `connectionString` e extraindo o nome `almoxarifado` dela. Portanto, o erro `FATAL: database "axiom" does exist` que aparece nos logs do servi√ßo `viajey / cassio POSTGRES` (o banco de dados em si) deve ser de uma tentativa de conex√£o anterior ou de um processo diferente que ainda est√° usando a string antiga.

**Recomenda√ß√£o:** Embora a string hardcoded esteja correta, a **melhor pr√°tica** √© sempre usar vari√°veis de ambiente para `DATABASE_URL` em *todos* os ambientes (desenvolvimento e produ√ß√£o). Isso evita a necessidade de recompilar o c√≥digo para mudar a string de conex√£o e garante maior flexibilidade e seguran√ßa. Voc√™ poderia simplificar a defini√ß√£o da `connectionString` para:

```typescript
const connectionString = process.env.DATABASE_URL;
```

E ent√£o garantir que a vari√°vel `DATABASE_URL` esteja sempre definida corretamente nos Secrets do Replit (para dev) e nas Environment Variables do EasyPanel (para prod). Se voc√™ optar por essa abordagem, lembre-se de que precisar√° de uma biblioteca como `dotenv` em desenvolvimento para carregar as vari√°veis de um arquivo `.env` local.

## 5. An√°lise do Dockerfile e Scripts de Entrada (`docker-entrypoint.sh`)

O Dockerfile e os scripts de entrada s√£o cruciais para como sua aplica√ß√£o √© constru√≠da e executada dentro do cont√™iner no EasyPanel. Vamos analisar o Dockerfile e o papel de um poss√≠vel `docker-entrypoint.sh`.

**Dockerfile (exemplo baseado nas informa√ß√µes):**

```dockerfile
FROM node:20-slim

WORKDIR /app

COPY package*.json ./
RUN npm ci

COPY . .

RUN npm run build

EXPOSE 5013

# Assume que h√° um docker-entrypoint.sh na raiz do projeto
ENTRYPOINT ["./docker-entrypoint.sh"]
```

**An√°lise:**

*   **`FROM node:20-slim`**: Baseia a imagem em uma vers√£o leve do Node.js 20, o que √© bom para otimiza√ß√£o de tamanho.
*   **`WORKDIR /app`**: Define o diret√≥rio de trabalho dentro do cont√™iner.
*   **`COPY package*.json ./` e `RUN npm ci`**: Copia os arquivos de depend√™ncia e instala-as. `npm ci` √© prefer√≠vel a `npm install` em ambientes de CI/CD para garantir builds reprodut√≠veis.
*   **`COPY . .`**: Copia o restante do c√≥digo-fonte para o cont√™iner.
*   **`RUN npm run build`**: Executa o script de build do seu projeto (provavelmente TypeScript para JavaScript, etc.).
*   **`EXPOSE 5013`**: Informa que o cont√™iner exp√µe a porta 5013, que √© a porta em que sua aplica√ß√£o Express est√° configurada para rodar (`const port = parseInt(process.env.PORT || "5000"); server.listen(port, "0.0.0.0", ...)`).
*   **`ENTRYPOINT ["./docker-entrypoint.sh"]`**: Esta linha √© muito importante. Ela define o comando que ser√° executado quando o cont√™iner for iniciado. Se voc√™ tem um script `docker-entrypoint.sh`, ele √© respons√°vel por qualquer configura√ß√£o de ambiente final ou inicializa√ß√£o de servi√ßos antes que a aplica√ß√£o principal seja iniciada.

**O Papel do `docker-entrypoint.sh` e `build-database-url.sh`:**

Voc√™ mencionou um script `build-database-url.sh` no relat√≥rio de investiga√ß√£o. Se este script for chamado dentro do `docker-entrypoint.sh`, ele pode ser respons√°vel por construir a `DATABASE_URL` dinamicamente a partir de vari√°veis de ambiente mais granulares (como `DB_USER`, `DB_PASS`, `DB_HOST`, `DB_NAME`).

**Exemplo de `docker-entrypoint.sh` (hipot√©tico, se voc√™ tiver um):**

```bash
#!/bin/bash

# Se voc√™ tiver um script para construir a DATABASE_URL
# ./build-database-url.sh

# Ou se voc√™ quiser garantir que DATABASE_URL esteja definida
# antes de iniciar a aplica√ß√£o
if [ -z "$DATABASE_URL" ]; then
  echo "Erro: DATABASE_URL n√£o est√° definida no ambiente do cont√™iner!"
  exit 1
fi

# Executa o comando principal da sua aplica√ß√£o
exec npm start # ou node dist/index.js, dependendo do seu package.json
```

**Verifica√ß√£o:**

*   **Confirme a exist√™ncia e o conte√∫do do `docker-entrypoint.sh`** na raiz do seu projeto. Se ele existe, verifique se ele est√° configurando a `DATABASE_URL` corretamente ou se est√° apenas passando as vari√°veis de ambiente diretamente para a aplica√ß√£o Node.js.
*   **Se n√£o houver um `docker-entrypoint.sh`**, o `ENTRYPOINT` no Dockerfile pode estar chamando diretamente `npm start` ou `node dist/index.js`. Nesse caso, a aplica√ß√£o depender√° exclusivamente das vari√°veis de ambiente definidas no EasyPanel.

Em resumo, o Dockerfile parece bem estruturado. O ponto crucial √© garantir que as vari√°veis de ambiente, especialmente a `DATABASE_URL`, sejam passadas corretamente para o cont√™iner e que qualquer script de entrada (`docker-entrypoint.sh`) n√£o esteja sobrescrevendo-as com valores incorretos ou antigos.

## 6. Passos de Verifica√ß√£o e Teste

Ap√≥s aplicar as corre√ß√µes no Replit e no EasyPanel, √© fundamental verificar se o problema foi resolvido. Siga estes passos:

1.  **Verifica√ß√£o no Replit (Ambiente de Desenvolvimento):**
    *   Ap√≥s reiniciar o Replit, observe os logs de inicializa√ß√£o da sua aplica√ß√£o. Voc√™ deve ver as mensagens de debug do `db-production-only.ts` (mesmo em dev, se a l√≥gica de `console.log` estiver ativa) indicando:
        ```
        Database host: viajey_cassio
        Database name: almoxarifado
        Database user: axiom
        Database port: 5432
        ```
        E, mais importante, **n√£o deve aparecer o erro `FATAL: database "axiom" does not exist`** nos logs do seu servi√ßo de aplica√ß√£o (o que aparece na imagem `viajey / almoxa APP`).
    *   Tente realizar opera√ß√µes que exigem conex√£o com o banco de dados (por exemplo, login, listagem de usu√°rios, etc.). Se tudo funcionar, a conex√£o est√° estabelecida corretamente.

2.  **Verifica√ß√£o no EasyPanel (Ambiente de Produ√ß√£o):**
    *   Ap√≥s o re-deploy no EasyPanel, acesse a se√ß√£o de **Logs** do seu servi√ßo (`viajey / almoxa APP`).
    *   Procure pelas mensagens de inicializa√ß√£o da sua aplica√ß√£o. Voc√™ deve ver os mesmos logs de debug que viu no Replit, confirmando que a `DATABASE_URL` com `almoxarifado` est√° sendo utilizada.
    *   **Crucial:** Verifique se n√£o h√° mais erros `FATAL: database "axiom" does not exist` nos logs do servi√ßo de banco de dados (`viajey / cassio POSTGRES`). Se ainda aparecer, pode ser um processo antigo ou um cache persistente. Tente reiniciar o servi√ßo de banco de dados tamb√©m, se poss√≠vel, ou entre em contato com o suporte do EasyPanel se o problema persistir apenas no lado do banco de dados.
    *   Acesse a URL p√∫blica da sua aplica√ß√£o implantada no EasyPanel. Tente realizar um login e outras opera√ß√µes para confirmar que a aplica√ß√£o est√° funcionando corretamente em produ√ß√£o.

## Conclus√£o

O erro `FATAL: database "axiom" does not exist` √© um problema de configura√ß√£o da string de conex√£o do banco de dados. Embora seu c√≥digo-fonte j√° aponte para `almoxarifado`, a persist√™ncia do erro indica que vari√°veis de ambiente desatualizadas ou caches de configura√ß√£o est√£o em jogo. Ao seguir este guia detalhado, voc√™ dever√° ser capaz de:

*   Garantir que a `DATABASE_URL` correta (`postgres://axiom:estruturas@viajey_cassio:5432/almoxarifado?sslmode=disable`) esteja configurada nos Secrets do Replit e nas Environment Variables do EasyPanel.
*   Reiniciar ambos os ambientes para que as novas configura√ß√µes sejam aplicadas.
*   Verificar os logs de inicializa√ß√£o da aplica√ß√£o para confirmar que a conex√£o est√° sendo feita com o banco de dados `almoxarifado`.

Lembre-se da import√¢ncia de manter a consist√™ncia entre os ambientes de desenvolvimento e produ√ß√£o, e de sempre utilizar vari√°veis de ambiente para dados sens√≠veis. Com estas corre√ß√µes, sua aplica√ß√£o dever√° se conectar ao banco de dados sem problemas, permitindo que voc√™ continue desenvolvendo e implantando com sucesso.

**Refer√™ncias:**

[1] Captura de tela das credenciais do Replit para o servi√ßo `viajey / cassio POSTGRES` (fornecida pelo usu√°rio).

[2] Logs de erro do servi√ßo `viajey / cassio POSTGRES` no Replit (fornecidos pelo usu√°rio).

[3] Logs da aplica√ß√£o `viajey / almoxa APP` no EasyPanel (fornecidos pelo usu√°rio).

[4] Trecho de c√≥digo `db-production-only.ts` (fornecido pelo usu√°rio).

[5] Captura de tela da interface de login e erro 401 (fornecida pelo usu√°rio).

[6] Captura de tela da estrutura do banco de dados `almoxarifado` (fornecida pelo usu√°rio).


